<?xml version="1.0" encoding="iso-8859-1"?>

<root>
	<windowclass name="charsheet_actions_contents" merge="join">
		<sheetdata>
			<sub_content_top name="rr_actions_contest">
				<class>rr_actions_contest</class>
			</sub_content_top>
		</sheetdata>
	</windowclass>

	<!-- The npc_combat classes add it to the NPC sheets -->
	<windowclass name="npc_combat_2024" merge="join">
		<sheetdata>
			<sub_content_column name="sub_rr_contest">
				<class>rr_actions_contest</class>
			</sub_content_column>
		</sheetdata>
	</windowclass>

	<windowclass name="npc_combat_2014" merge="join">
		<sheetdata>
			<sub_content_column name="sub_rr_contest">
				<class>rr_actions_contest</class>
			</sub_content_column>
		</sheetdata>
	</windowclass>

	<windowclass name="rr_actions_contest">
		<margins control="0,0,0,2" />
		<sheetdata>
			<anchor_content_top />

			<label_charframetop name="contest_header">
				<anchored to="contentanchor" height="20">
					<top relation="relative" offset="8" postoffset="8" />
					<left offset="10" />
					<right offset="-10" />
				</anchored>
				<icons>char_attacks</icons>
				<static textres="RR_header_contestSubSheet" />
				<script>
					function onClickDown()
						return true;
					end
					function onClickRelease()
						local bVisible = window.contests.isVisible ();
						if bVisible then
							setFont("subwindowsmalltitle_disabled");
							window.contests.setVisible(false);
						else
							setFont("subwindowsmalltitle");
							window.contests.setVisible(true);
						end
						return true;
					end
				</script>
			</label_charframetop>
			<list_content_noscroll_top name="contests">
				<datasource>requestsheet.contest</datasource>
				<class>rr_actions_contest_buttons</class>
				<sortby><control>name</control></sortby>
			</list_content_noscroll_top>
		</sheetdata>
	</windowclass>

	<windowclass name="rr_actions_contest_buttons">
		<sheetdata>
			<anchor_listitem_left_sm />
			<anchor_listitem_right_sm />
			<spacer_listitem_left/>
			<string_listitem_left_underline_static name="name">
				<anchored width="250"/>
			</string_listitem_left_underline_static>
			<button_listitem_roll_left>
				<script>
					function onDragStart(_, _, _, draginfo)
						local contestNode = DB.getPath(window.getDatabaseNode());
						local rActor = ActorManager.resolveActor(WindowManager.getTopWindow(window).getDatabaseNode());

						local fRollResult = RRRollManager.getRollGetter(RRContestManager.getRollType(contestNode));
						local rRoll = fRollResult(rActor, RRContestManager.getFirstOriginSubType(contestNode));
						rRoll.bContest = true;
						rRoll.contestNode = contestNode;
						ActionsManager.performAction(draginfo, rActor, rRoll);
						draginfo.setType("contest");
						return true;
					end
					function onButtonPress()
						local contestNode = DB.getPath(window.getDatabaseNode());
						local rActor = ActorManager.resolveActor(WindowManager.getTopWindow(window).getDatabaseNode());

						local fRollResult = RRRollManager.getRollGetter(RRContestManager.getRollType(contestNode));
						local rRoll = fRollResult(rActor, RRContestManager.getFirstOriginSubType(contestNode));
						rRoll.bContest = true;
						rRoll.contestNode = contestNode;
						local rTargets = TargetingManager.getFullTargets(rActor);
						--We have to convert target table to string or it will get lost when converted in buildThrow
						local rsTargets = {};
						for k,v in pairs(rTargets) do
							table.insert(rsTargets, ActorManager.getCreatureNodeName(v));
						end
						local sTargets = table.concat(rsTargets,"#||#");
						rRoll.contestTargets = sTargets;
						ActionsManager.performAction(draginfo, rActor, rRoll);
					end
				</script>
			</button_listitem_roll_left>
		</sheetdata>
	</windowclass>
</root>
